<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mendeley Uploader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-window {
            height: 400px;
            overflow-y: scroll;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #eee;}
        .log-INFO { color: #0f5132; }
        .log-WARNING { color: #856404; font-weight: bold;}
        .log-ERROR { color: #842029; font-weight: bold; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Mendeley PDF Bulk Uploader</h4>
                </div>
                <div class="card-body">
                    
                    <div class="mb-4">
                        <label for="pathInput" class="form-label">Folder or File Path (Absolute Path)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="pathInput" placeholder="C:\\Users\\Owner\\Documents\\jan-books-2026-pdfs">
                            <button class="btn btn-success" id="btnStart" onclick="startUpload()">Start Upload</button>
                            <button class="btn btn-danger" id="btnStop" onclick="stopUpload()" disabled>Stop</button>
                        </div>
                        <div class="form-text">Server will confirm access and start background processing.</div>
                    </div>

                    <div class="mb-3">
                        <h5>Status: <span id="statusMessage" class="badge bg-secondary">Idle</span></h5>
                        <p class="mb-1">Current File: <span id="currentFile" class="text-muted">-</span></p>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small>Processed: <span id="processedCount">0</span></small>
                            <small>Total: <span id="totalCount">0</span></small>
                        </div>
                    </div>

                    <hr>

                    <h5>Process Logs</h5>
                    <div class="log-window" id="logWindow">
                        <!-- Logs go here -->
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let pollInterval = null;

    async function startUpload() {
        const path = document.getElementById('pathInput').value;
        if (!path) return alert("Please enter a path");

        try {
            const res = await fetch('/api/start-upload', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: path})
            });
            
            if (!res.ok) {
                const err = await res.json();
                return alert("Error: " + err.detail);
            }
            
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;
            startPolling();
            
        } catch (e) {
            alert("Network Error: " + e);
        }
    }

    async function stopUpload() {
        await fetch('/api/stop', {method: 'POST'});
    }

    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(updateStatus, 1000);
    }

    async function updateStatus() {
        try {
            // Fetch Status
            const statusRes = await fetch('/api/status');
            const status = await statusRes.json();

            document.getElementById('statusMessage').innerText = status.status_message;
            document.getElementById('currentFile').innerText = status.current_file || "-";
            document.getElementById('processedCount').innerText = status.processed_files;
            document.getElementById('totalCount').innerText = status.total_files;

            if (status.total_files > 0) {
                const pct = Math.round((status.processed_files / status.total_files) * 100);
                const bar = document.getElementById('progressBar');
                bar.style.width = pct + "%";
                bar.innerText = pct + "%";
            }

            if (!status.is_running) {
                 document.getElementById('btnStart').disabled = false;
                 document.getElementById('btnStop').disabled = true;
                 document.getElementById('statusMessage').className = "badge bg-success";
            } else {
                 document.getElementById('statusMessage').className = "badge bg-warning text-dark";
            }

            // Fetch Logs
            const logRes = await fetch('/api/logs');
            const logData = await logRes.json();
            renderLogs(logData.logs);

        } catch (e) {
            console.error("Polling error", e);
        }
    }

    function renderLogs(logs) {
        const win = document.getElementById('logWindow');
        win.innerHTML = logs.map(line => {
             let cls = "";
             if (line.includes("INFO")) cls = "log-INFO";
             if (line.includes("WARNING")) cls = "log-WARNING";
             if (line.includes("ERROR")) cls = "log-ERROR";
             return `<div class="log-entry ${cls}">${line}</div>`;
        }).join('');
        win.scrollTop = win.scrollHeight;
    }
    
    // Initial fetch
    updateStatus();
    startPolling();

</script>
</body>
</html>
